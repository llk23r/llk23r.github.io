---
import Layout from '~/layouts/Layout.astro'
import { getSortedPosts, SeriesGroup } from '~/utils'
import { render } from 'astro:content'

const sortedPosts = await getSortedPosts()

// Build read time map
const readTimeMap = new Map<string, string>()
for (const post of sortedPosts) {
  const { remarkPluginFrontmatter } = await render(post)
  if (remarkPluginFrontmatter?.minutesRead) {
    readTimeMap.set(post.id, remarkPluginFrontmatter.minutesRead)
  }
}

// Group series posts
const seriesGroup = await SeriesGroup.build(sortedPosts)
seriesGroup.sortCollationsMostRecent()
const seriesPostIds = new Set(
  seriesGroup.collations.flatMap((s) => s.entries.map((e) => e.id)),
)

// Standalone posts (not in any series), newest first
const standalonePosts = [...sortedPosts].filter((p) => !seriesPostIds.has(p.id)).reverse()

function formatDate(date: Date): string {
  return date.toISOString().slice(0, 10)
}
---

<Layout>
  <div class="md:mx-2">
    {
      seriesGroup.collations.map((series) => (
        <section class="mt-6">
          <h2 class="home-section-label">
            <a href={series.url}>{series.title.toUpperCase()}</a>
          </h2>
          <ul class="home-post-list">
            {[...series.entries].reverse().map((post) => (
              <li class="home-post-row">
                <time datetime={post.data.published.toISOString()}>
                  {formatDate(post.data.published)}
                </time>
                <a href={`/posts/${post.id}`}>{post.data.title}</a>
                {readTimeMap.get(post.id) && (
                  <span class="home-post-readtime">{readTimeMap.get(post.id)}</span>
                )}
              </li>
            ))}
          </ul>
        </section>
      ))
    }
    {
      standalonePosts.length > 0 && (
        <section class="mt-6">
          <h2 class="home-section-label">POSTS</h2>
          <ul class="home-post-list">
            {standalonePosts.map((post) => (
              <li class="home-post-row">
                <time datetime={post.data.published.toISOString()}>
                  {formatDate(post.data.published)}
                </time>
                <a href={`/posts/${post.id}`}>{post.data.title}</a>
                {readTimeMap.get(post.id) && (
                  <span class="home-post-readtime">{readTimeMap.get(post.id)}</span>
                )}
              </li>
            ))}
          </ul>
        </section>
      )
    }
  </div>
</Layout>

<style>
  .home-section-label {
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    color: color-mix(in srgb, var(--theme-accent) 50%, transparent);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .home-section-label a {
    color: inherit;
    text-decoration: none;
  }

  .home-section-label a:hover {
    color: var(--theme-accent);
  }

  .home-post-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .home-post-row {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    padding: 0.375rem 0;
    font-size: 0.875rem;
  }

  .home-post-row time {
    color: color-mix(in srgb, var(--theme-foreground) 40%, transparent);
    font-size: 0.8125rem;
    flex-shrink: 0;
  }

  .home-post-row a {
    color: var(--theme-accent);
    text-decoration: none;
  }

  .home-post-row a:hover {
    text-decoration: underline;
  }

  .home-post-readtime {
    color: color-mix(in srgb, var(--theme-foreground) 25%, transparent);
    font-size: 0.75rem;
    flex-shrink: 0;
    margin-left: auto;
    display: none;
  }

  @media (min-width: 640px) {
    .home-post-readtime {
      display: inline;
    }
  }
</style>

<style is:global>
  a.heading-anchor {
    display: none !important;
  }
</style>
