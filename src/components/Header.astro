---
import siteConfig from '~/site.config'
import LightDarkAutoButton from '~/components/LightDarkAutoButton.astro'
import Search from '~/components/Search.astro'
import NavLink from '~/components/NavLink.astro'
import IconMenu from '~/icons/menu.svg'

const lightDarkAutoTheme = siteConfig.themes.mode === 'light-dark-auto'
---

<header>
  <div class="kap-surface relative flex items-center justify-between rounded-xl">
    <a
      id="logo"
      href="/"
      class="block px-4 py-1.5 max-w-full no-underline items-center bg-accent text-background font-bold rounded-xl"
    >
      {siteConfig.title}
    </a>
    <div class="flex items-center gap-3 sm:mr-3">
      <Search trailingSlashes={siteConfig.trailingSlashes} />
      {lightDarkAutoTheme && <LightDarkAutoButton />}
      <nav id="nav-mobile" aria-label="Menu" class="p-0 text-accent sm:hidden">
        <button
          id="nav-mobile-button"
          class="p-2 h-full cursor-pointer rounded-xl"
          type="button"
          aria-expanded="false"
          aria-controls="nav-menu-list"
        >
          <IconMenu class="size-5 text-accent" />
        </button>
        <ul
          id="nav-mobile-list"
          class="kap-surface absolute flex flex-col shadow text-accent m-0 p-2.5 top-11.5 left-auto right-0 z-50 rounded-xl"
          style="opacity: 0; transform: translateY(-8px); pointer-events: none; transition: opacity 150ms ease, transform 150ms ease;"
        >
          {
            siteConfig.navLinks.map((link) => (
              <li class="p-1" aria-expanded="false">
                <NavLink link={link} />
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
  <nav aria-label="Menu" class="p-0 mt-4 ml-0.5 text-accent hidden sm:block">
    <ul class="flex flex-row text-accent">
      {
        siteConfig.navLinks.map((link) => (
          <li class="mr-5" aria-expanded="true">
            <NavLink link={link} />
          </li>
        ))
      }
    </ul>
  </nav>
</header>

<script>
  const navMobileButton = document.getElementById('nav-mobile-button')
  const navMobileList = document.getElementById('nav-mobile-list')
  const navMobileListItems = navMobileList?.querySelectorAll('li')
  const setNavOpen = (open: boolean) => {
    if (!navMobileList) return
    if (open) {
      navMobileList.style.opacity = '1'
      navMobileList.style.transform = 'translateY(0)'
      navMobileList.style.pointerEvents = 'auto'
    } else {
      navMobileList.style.opacity = '0'
      navMobileList.style.transform = 'translateY(-8px)'
      navMobileList.style.pointerEvents = 'none'
    }
    navMobileButton?.setAttribute('aria-expanded', open ? 'true' : 'false')
    navMobileListItems?.forEach((listItem) => {
      listItem.setAttribute('aria-expanded', open ? 'true' : 'false')
    })
  }
  const toggleNavMobileMenu = (action: 'on' | 'off' | 'toggle') => {
    const isCurrentlyOpen = navMobileList?.style.opacity === '1'
    if (action === 'on') setNavOpen(true)
    else if (action === 'off') setNavOpen(false)
    else setNavOpen(!isCurrentlyOpen)
  }
  navMobileButton?.addEventListener('click', (_ev) => {
    toggleNavMobileMenu('toggle')
  })
</script>
