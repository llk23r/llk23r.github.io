---
import type { MarkdownHeading } from 'astro'
import TOCHeading from '~/components/TableOfContentsHeading.astro'
import IconList from '~/icons/list.svg'

interface Props {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props

const filteredHeadings = headings.filter(({ depth }) => depth >= 2 && depth <= 3)
---

<!-- Mobile: floating trigger button -->
<button
  class="toc-mobile-trigger lg:hidden kap-surface-interactive fixed z-50 bottom-3 left-3 size-11 flex items-center justify-center !rounded-full md:size-12 md:bottom-5 md:left-5"
  aria-label="Table of Contents"
  title="Table of Contents"
>
  <IconList class="text-accent/50 size-6 lg:size-7" />
  <span class="toc-trigger-label">Contents</span>
</button>

<!-- Mobile: backdrop -->
<div class="toc-mobile-backdrop lg:hidden fixed inset-0 bg-black/40 z-50 hidden" aria-hidden="true"></div>

<!-- Mobile: bottom sheet drawer -->
<div class="toc-mobile-drawer lg:hidden fixed bottom-0 left-0 right-0 z-50 translate-y-full transition-transform duration-300 ease-out">
  <div class="rounded-t-2xl px-6 pt-5 pb-6 max-h-[60vh] flex flex-col" style="background: var(--theme-background); border-top: 1px solid var(--kap-border-top); border-right: 1px solid var(--kap-border-right); border-left: 1px solid var(--kap-border-right);">
    <div class="flex items-center justify-between mb-4">
      <span class="text-foreground/90 font-semibold text-sm">Contents</span>
      <button class="toc-mobile-close text-foreground/50 hover:text-foreground/80 p-1" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <nav class="toc-mobile-nav overflow-y-auto flex-1 min-h-0">
      <details class="toc-media-section" open>
        <summary class="toc-media-heading">Sections <span class="toc-media-count">{filteredHeadings.length}</span></summary>
        <ul class="toc-media-list flex flex-col gap-0.5">
          {filteredHeadings.map((heading) => <TOCHeading heading={heading} />)}
        </ul>
      </details>
    </nav>
  </div>
</div>

<!-- Desktop: sticky sidebar -->
<details
  open
  class="toc hidden lg:block text-foreground/90 text-sm bg-transparent px-4 py-4 rounded-xl border-none shadow-none sticky top-24 shrink-0 w-[220px] xl:w-[274px] max-h-[calc(100vh-8rem)] overflow-hidden"
>
  <summary class="list-none marker:hidden marker:content-[''] cursor-default text-foreground/90 font-semibold text-sm">Contents</summary>
  <nav class="toc-nav w-full mt-4 max-h-[calc(100vh-13rem)] overflow-y-auto">
    <details class="toc-media-section" open>
      <summary class="toc-media-heading">Sections <span class="toc-media-count">{filteredHeadings.length}</span></summary>
      <ul class="toc-list toc-media-list flex flex-col gap-0.5 max-w-full">
        {filteredHeadings.map((heading) => <TOCHeading heading={heading} />)}
      </ul>
    </details>
  </nav>
</details>

<script>
  function initToc() {
    const anchors = document.querySelectorAll('h2[id], h3[id]')
    const desktopItems = document.querySelectorAll('details.toc .toc-item')
    const mobileItems = document.querySelectorAll('.toc-mobile-drawer .toc-item')
    const tocNav = document.querySelector('details.toc .toc-nav')

    if (anchors.length === 0) return

    // --- Mobile drawer ---
    const trigger = document.querySelector('.toc-mobile-trigger') as HTMLElement
    const backdrop = document.querySelector('.toc-mobile-backdrop') as HTMLElement
    const drawer = document.querySelector('.toc-mobile-drawer') as HTMLElement
    const closeBtn = document.querySelector('.toc-mobile-close') as HTMLElement

    function openDrawer() {
      if (!backdrop || !drawer) return
      backdrop.classList.remove('hidden')
      drawer.classList.remove('translate-y-full')
      document.body.style.overflow = 'hidden'
    }

    function closeDrawer() {
      if (!backdrop || !drawer) return
      backdrop.classList.add('hidden')
      drawer.classList.add('translate-y-full')
      document.body.style.overflow = ''
    }

    trigger?.addEventListener('click', openDrawer)
    backdrop?.addEventListener('click', closeDrawer)
    closeBtn?.addEventListener('click', closeDrawer)

    // Close drawer on heading link click
    mobileItems.forEach((item) => {
      item.querySelector('a')?.addEventListener('click', () => {
        closeDrawer()
      })
    })

    // Close drawer on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) closeDrawer()
    })

    // --- Active heading tracking ---
    let userScrolledToc = false
    let userScrollTimer: ReturnType<typeof setTimeout>
    if (tocNav) {
      tocNav.addEventListener('scroll', () => {
        userScrolledToc = true
        clearTimeout(userScrollTimer)
        userScrollTimer = setTimeout(() => { userScrolledToc = false }, 2000)
      }, { passive: true })
    }

    function applyActiveState(items: NodeListOf<Element>, activeIndex: number) {
      items.forEach((item, i) => {
        item.classList.remove('active-heading', 'past')
        if (i === activeIndex) {
          item.classList.add('active-heading')
        } else if (activeIndex >= 0 && i < activeIndex) {
          item.classList.add('past')
        }
      })
    }

    function updateActiveHeading() {
      const scrollTop = window.scrollY
      let activeIndex = -1

      for (let i = anchors.length - 1; i >= 0; i--) {
        const anchor = anchors[i] as HTMLElement
        if (scrollTop > anchor.offsetTop - 75) {
          activeIndex = i
          break
        }
      }

      if (desktopItems.length === anchors.length) {
        applyActiveState(desktopItems, activeIndex)
      }
      if (mobileItems.length === anchors.length) {
        applyActiveState(mobileItems, activeIndex)
      }

      // Auto-scroll desktop TOC
      if (activeIndex >= 0 && tocNav && window.innerWidth >= 1024 && !userScrolledToc) {
        const activeItem = desktopItems[activeIndex] as HTMLElement
        const navRect = tocNav.getBoundingClientRect()
        const itemRect = activeItem.getBoundingClientRect()

        if (itemRect.top < navRect.top || itemRect.bottom > navRect.bottom) {
          activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' })
        }
      }
    }

    window.addEventListener('scroll', updateActiveHeading, { passive: true })
    updateActiveHeading()

    // --- Media Navigator ---
    initMediaNav(closeDrawer)
  }

  function initMediaNav(closeDrawer: () => void) {
    const article = document.querySelector('article')
    if (!article) return

    const SKIP_COMPONENTS = new Set(['JourneyMap'])

    function pascalToReadable(name: string): string {
      return name
        .replace(/([A-Z]+)([A-Z][a-z])/g, '$1 $2')
        .replace(/([a-z])([A-Z])/g, '$1 $2')
    }

    // Discover visualizations (astro-island components)
    type MediaItem = { element: Element; label: string }
    const vizItems: MediaItem[] = []
    article.querySelectorAll('astro-island').forEach((island) => {
      const opts = island.getAttribute('opts')
      if (!opts) return
      try {
        const parsed = JSON.parse(opts)
        const name = parsed.name
        if (!name || SKIP_COMPONENTS.has(name)) return
        vizItems.push({ element: island, label: pascalToReadable(name) })
      } catch {}
    })

    // Discover images (skip cover image — anything before first h2)
    const imgItems: MediaItem[] = []
    const firstH2 = article.querySelector('.prose h2')
    article.querySelectorAll('.prose img').forEach((img) => {
      if (firstH2 && img.compareDocumentPosition(firstH2) & Node.DOCUMENT_POSITION_FOLLOWING) return
      const figure = img.closest('figure')
      const caption = figure?.querySelector('figcaption')
      const label = caption?.textContent?.trim() || (img as HTMLImageElement).alt || 'Image'
      imgItems.push({ element: figure || img, label })
    })

    if (vizItems.length === 0 && imgItems.length === 0) return

    // Build media nav DOM
    function buildSection(heading: string, items: MediaItem[], type: string): HTMLDetailsElement {
      const section = document.createElement('details')
      section.className = 'toc-media-section'

      const summary = document.createElement('summary')
      summary.className = 'toc-media-heading'
      summary.innerHTML = `${heading} <span class="toc-media-count">${items.length}</span>`
      section.appendChild(summary)

      const ul = document.createElement('ul')
      ul.className = 'toc-media-list'

      items.forEach((item, i) => {
        const li = document.createElement('li')
        li.className = `toc-media-item toc-media-${type}`
        li.dataset.mediaType = type
        li.dataset.mediaIndex = String(i)

        const idx = document.createElement('span')
        idx.className = 'toc-media-idx'
        idx.textContent = String(i + 1).padStart(2, '0')

        const btn = document.createElement('button')
        btn.textContent = item.label
        btn.title = item.label
        btn.addEventListener('click', () => {
          item.element.scrollIntoView({ behavior: 'smooth', block: 'center' })
          // Brief highlight flash on target
          const el = item.element as HTMLElement
          el.classList.add('toc-scroll-target')
          el.addEventListener('animationend', () => el.classList.remove('toc-scroll-target'), { once: true })
          closeDrawer()
        })

        li.appendChild(idx)
        li.appendChild(btn)
        ul.appendChild(li)
      })

      section.appendChild(ul)
      return section
    }

    function buildMediaNav(): HTMLDivElement {
      const container = document.createElement('div')
      container.className = 'toc-media-nav'
      if (vizItems.length > 0) container.appendChild(buildSection('Visualizations', vizItems, 'viz'))
      if (imgItems.length > 0) container.appendChild(buildSection('Figures', imgItems, 'img'))
      return container
    }

    // Inject into desktop and mobile ToC
    const desktopNav = document.querySelector('details.toc .toc-nav')
    const mobileNav = document.querySelector('.toc-mobile-nav')

    if (desktopNav) desktopNav.appendChild(buildMediaNav())
    if (mobileNav) mobileNav.appendChild(buildMediaNav())

    // Active tracking via IntersectionObserver
    const allItems = [...vizItems.map((v, i) => ({ ...v, type: 'viz', index: i })), ...imgItems.map((v, i) => ({ ...v, type: 'img', index: i }))]

    function setActiveMedia(type: string, index: number) {
      document.querySelectorAll('.toc-media-item').forEach((el) => {
        const htmlEl = el as HTMLElement
        if (htmlEl.dataset.mediaType === type && htmlEl.dataset.mediaIndex === String(index)) {
          htmlEl.classList.add('active-media')
        } else {
          htmlEl.classList.remove('active-media')
        }
      })
    }

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement
            const match = allItems.find((item) => item.element === el)
            if (match) setActiveMedia(match.type, match.index)
          }
        }
      },
      { rootMargin: '-20% 0px -60% 0px', threshold: 0 },
    )

    allItems.forEach((item) => observer.observe(item.element))
  }

  initToc()
</script>

<style>
  /* Mobile trigger label + entrance animation */
  .toc-trigger-label {
    position: absolute;
    left: calc(100% + 8px);
    font-size: 0.65rem;
    font-weight: 600;
    white-space: nowrap;
    color: color-mix(in srgb, var(--theme-foreground) 50%, transparent);
    opacity: 0;
    transform: translateX(-4px);
    animation: toc-label-entrance 3s 1.5s ease forwards;
    pointer-events: none;
  }

  @keyframes toc-label-entrance {
    0% { opacity: 0; transform: translateX(-4px); }
    15% { opacity: 1; transform: translateX(0); }
    70% { opacity: 1; transform: translateX(0); }
    100% { opacity: 0; transform: translateX(-4px); }
  }

  @media (min-width: 1024px) {
    .toc-trigger-label {
      display: none;
    }
  }

  /* Scrollbar styling for TOC navs */
  .toc-nav::-webkit-scrollbar,
  .toc-mobile-nav::-webkit-scrollbar {
    width: 3px;
  }
  .toc-nav::-webkit-scrollbar-track,
  .toc-mobile-nav::-webkit-scrollbar-track {
    background: transparent;
  }
  .toc-nav::-webkit-scrollbar-thumb,
  .toc-mobile-nav::-webkit-scrollbar-thumb {
    background: var(--theme-separator);
    border-radius: 3px;
  }

  /* Media Navigator */
  :global(.toc-media-nav) {
    margin-top: 8px;
    padding-top: 0;
  }

  /* Section = collapsible <details> */
  :global(.toc-media-section) {
    margin-top: 8px;
  }

  :global(.toc-media-section:first-child) {
    margin-top: 0;
  }

  :global(.toc-media-heading) {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    list-style: none;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: color-mix(in srgb, var(--theme-foreground) 50%, transparent);
    padding: 4px 8px 4px 14px;
    user-select: none;
  }

  :global(.toc-media-heading)::marker,
  :global(.toc-media-heading)::-webkit-details-marker {
    display: none;
  }

  :global(.toc-media-heading)::before {
    content: '▸';
    font-size: 0.65rem;
    transition: transform 0.15s ease;
  }

  :global(.toc-media-section[open]) > :global(.toc-media-heading)::before {
    transform: rotate(90deg);
  }

  :global(.toc-media-heading:hover) {
    color: color-mix(in srgb, var(--theme-foreground) 70%, transparent);
  }

  :global(.toc-media-count) {
    font-size: 0.6rem;
    font-weight: 500;
    color: color-mix(in srgb, var(--theme-foreground) 30%, transparent);
    margin-left: auto;
  }

  :global(.toc-media-list) {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  :global(.toc-media-item) {
    display: flex;
    align-items: baseline;
    gap: 6px;
    border-left: 2px solid transparent;
    padding: 2px 8px 2px 12px;
    transition: border-color 0.15s, padding-left 0.15s;
    overflow: hidden;
  }

  :global(.toc-media-item:hover) {
    border-left-color: color-mix(in srgb, var(--theme-accent) 40%, transparent);
    padding-left: 14px;
  }

  :global(.toc-media-idx) {
    flex-shrink: 0;
    font-size: 0.6rem;
    font-weight: 500;
    color: color-mix(in srgb, var(--theme-foreground) 25%, transparent);
    font-variant-numeric: tabular-nums;
    min-width: 1.4em;
  }

  :global(.toc-media-item button) {
    all: unset;
    display: block;
    cursor: pointer;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: left;
    color: color-mix(in srgb, var(--theme-foreground) 55%, transparent);
    font-family: inherit;
    font-size: 0.7rem;
    line-height: 1.5;
    flex: 1;
  }

  :global(.toc-media-item button:hover) {
    color: var(--theme-accent);
  }

  :global(.toc-media-item.active-media) {
    border-left-color: var(--theme-accent);
  }

  :global(.toc-media-item.active-media .toc-media-idx) {
    color: var(--theme-accent);
  }

  :global(.toc-media-item.active-media button) {
    color: var(--theme-accent);
    font-weight: 600;
  }

  /* Mobile: larger touch targets */
  :global(.toc-mobile-drawer .toc-media-item) {
    padding: 6px 8px 6px 14px;
  }

  :global(.toc-mobile-drawer .toc-media-item button) {
    font-size: 0.78rem;
  }

  :global(.toc-mobile-drawer .toc-media-heading) {
    font-size: 0.73rem;
    padding: 6px 8px 6px 14px;
  }

  /* Scroll-to highlight flash */
  @keyframes toc-highlight {
    0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--theme-accent) 40%, transparent); }
    40% { box-shadow: 0 0 0 4px color-mix(in srgb, var(--theme-accent) 25%, transparent); }
    100% { box-shadow: 0 0 0 0 transparent; }
  }

  :global(.toc-scroll-target) {
    animation: toc-highlight 1.7s ease-out;
    border-radius: 8px;
  }
</style>
